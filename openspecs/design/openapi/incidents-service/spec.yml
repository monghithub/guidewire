##############################################################################
# SPEC: OpenAPI — Microservicio de Incidencias
# Issue: #43
##############################################################################

metadata:
  name: openapi-incidents-service
  type: design
  subtype: openapi
  issue: 43
  labels: [design, openapi, incidents]
  status: pending
  priority: high
  depends_on: []

description: >
  Especificación OpenAPI 3.1 para el microservicio de incidencias.
  Gestiona incidencias derivadas de siniestros de ClaimCenter,
  alimentadas por eventos Kafka.

specification:
  format: OpenAPI 3.1
  file: incidents-service-api.yml
  base_path: /api/v1/incidents
  register_in: apicurio (grupo: guidewire-openapi)

  info:
    title: Incidents Microservice API
    version: "1.0.0"

  endpoints:
    - method: GET
      path: /incidents
      summary: Listar incidencias
      query_params:
        - name: status
          type: string
          enum: [OPEN, IN_PROGRESS, RESOLVED, CLOSED, ESCALATED]
        - name: priority
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        - name: claimId
          type: string
          format: uuid
        - name: customerId
          type: string
          format: uuid
        - name: page
          type: integer
        - name: size
          type: integer
      response: PaginatedIncidentList

    - method: GET
      path: /incidents/{incidentId}
      summary: Obtener incidencia por ID
      response: Incident

    - method: POST
      path: /incidents
      summary: Crear incidencia
      request: CreateIncidentRequest
      response: Incident
      status: 201

    - method: PATCH
      path: /incidents/{incidentId}
      summary: Actualizar incidencia
      request: UpdateIncidentRequest
      response: Incident

  models:
    Incident:
      properties:
        incidentId:
          type: string
          format: uuid
        claimId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        status:
          type: string
          enum: [OPEN, IN_PROGRESS, RESOLVED, CLOSED, ESCALATED]
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        title:
          type: string
        description:
          type: string
        assignedTo:
          type: string
          nullable: true
        resolution:
          type: string
          nullable: true
        sourceEvent:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateIncidentRequest:
      required: [claimId, customerId, title, description]
      properties:
        claimId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        title:
          type: string
          minLength: 5
        description:
          type: string
          minLength: 10
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
          default: MEDIUM

    UpdateIncidentRequest:
      properties:
        status:
          type: string
        priority:
          type: string
        assignedTo:
          type: string
        resolution:
          type: string

  status_transitions:
    OPEN: [IN_PROGRESS, ESCALATED, CLOSED]
    IN_PROGRESS: [RESOLVED, ESCALATED]
    ESCALATED: [IN_PROGRESS, RESOLVED]
    RESOLVED: [CLOSED]
    CLOSED: []

code_generation:
  tool: openapi-generator-maven-plugin
  language: java
  library: quarkus
  package: com.guidewire.incidents.api

acceptance_criteria:
  - Spec OpenAPI válida y registrada en Apicurio
  - Generación de código produce interfaces Quarkus/JAX-RS
  - Filtros por status, priority, claimId y customerId
  - Transiciones de estado validadas
