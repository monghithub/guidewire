openapi: "3.1.0"
info:
  title: Customers Microservice API
  version: "1.0.0"
  description: |
    API REST del microservicio de clientes.

    Gestiona el registro y estado de clientes del ecosistema de seguros.
    Implementado en Node.js/TypeScript. Soporta busqueda parcial por nombre.

    ## Transiciones de estado permitidas

    | Estado actual | Estados siguientes permitidos     |
    |---------------|----------------------------------|
    | ACTIVE        | INACTIVE, SUSPENDED, BLOCKED     |
    | INACTIVE      | ACTIVE                           |
    | SUSPENDED     | ACTIVE, BLOCKED                  |
    | BLOCKED       | _(requiere intervencion manual)_ |

    ## Validaciones de unicidad
    - El campo `email` debe ser unico en todo el sistema.
    - El campo `documentNumber` debe ser unico por `documentType`.
  contact:
    name: Customers Microservice Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:8085
    description: Local development server

paths:
  /api/v1/customers:
    get:
      operationId: listCustomers
      summary: Listar clientes
      description: |
        Retorna una lista paginada de clientes con filtros opcionales.
        El parametro `name` realiza busqueda parcial (LIKE) por firstName o lastName.
      tags:
        - Customers
      parameters:
        - name: status
          in: query
          required: false
          description: Filtrar por estado del cliente
          schema:
            $ref: "#/components/schemas/CustomerStatus"
        - name: email
          in: query
          required: false
          description: Filtrar por email exacto
          schema:
            type: string
            format: email
        - name: name
          in: query
          required: false
          description: Busqueda parcial por nombre o apellido (case-insensitive)
          schema:
            type: string
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: size
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: Lista paginada de clientes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedCustomerList"
              example:
                content:
                  - customerId: "c1d2e3f4-a5b6-7890-cdef-123456789abc"
                    firstName: "Maria"
                    lastName: "Garcia Lopez"
                    email: "maria.garcia@example.com"
                    phone: "+52-55-1234-5678"
                    documentType: RFC
                    documentNumber: "GALM850101ABC"
                    status: ACTIVE
                    address:
                      street: "Av. Reforma 222, Piso 10"
                      city: "Ciudad de Mexico"
                      state: "CDMX"
                      zipCode: "06600"
                      country: "MX"
                    createdAt: "2024-01-05T12:00:00Z"
                    updatedAt: "2024-01-05T12:00:00Z"
                page: 0
                size: 20
                totalElements: 1
                totalPages: 1
        "400":
          description: Solicitud invalida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      operationId: createCustomer
      summary: Registrar nuevo cliente
      description: |
        Registra un nuevo cliente en estado ACTIVE.
        Valida unicidad de email y documentNumber por documentType.
      tags:
        - Customers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCustomerRequest"
            example:
              firstName: "Maria"
              lastName: "Garcia Lopez"
              email: "maria.garcia@example.com"
              phone: "+52-55-1234-5678"
              documentType: RFC
              documentNumber: "GALM850101ABC"
              address:
                street: "Av. Reforma 222, Piso 10"
                city: "Ciudad de Mexico"
                state: "CDMX"
                zipCode: "06600"
                country: "MX"
      responses:
        "201":
          description: Cliente registrado exitosamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Customer"
        "400":
          description: Solicitud invalida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: VALIDATION_ERROR
                message: "email is required"
                timestamp: "2024-01-05T12:00:00Z"
                path: /api/v1/customers
        "409":
          description: Conflicto de unicidad (email o documento duplicado)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: DUPLICATE_RESOURCE
                message: "A customer with email maria.garcia@example.com already exists"
                timestamp: "2024-01-05T12:00:00Z"
                path: /api/v1/customers
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/customers/{customerId}:
    get:
      operationId: getCustomerById
      summary: Obtener cliente por ID
      tags:
        - Customers
      parameters:
        - name: customerId
          in: path
          required: true
          description: UUID del cliente
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Cliente encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Customer"
        "404":
          description: Cliente no encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: NOT_FOUND
                message: "Customer with ID c1d2e3f4-a5b6-7890-cdef-123456789abc not found"
                timestamp: "2024-01-05T12:00:00Z"
                path: /api/v1/customers/c1d2e3f4-a5b6-7890-cdef-123456789abc
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      operationId: updateCustomer
      summary: Actualizar cliente
      description: Permite actualizar datos y estado de un cliente.
      tags:
        - Customers
      parameters:
        - name: customerId
          in: path
          required: true
          description: UUID del cliente
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateCustomerRequest"
            example:
              phone: "+52-55-9876-5432"
              address:
                street: "Av. Insurgentes Sur 1500"
                city: "Ciudad de Mexico"
                state: "CDMX"
                zipCode: "03920"
                country: "MX"
      responses:
        "200":
          description: Cliente actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Customer"
        "400":
          description: Solicitud invalida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Cliente no encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Transicion de estado no permitida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: INVALID_STATE_TRANSITION
                message: "Cannot transition from BLOCKED to INACTIVE"
                timestamp: "2024-01-05T12:00:00Z"
                path: /api/v1/customers/c1d2e3f4-a5b6-7890-cdef-123456789abc
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    CustomerStatus:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
        - SUSPENDED
        - BLOCKED
      description: |
        Estado del cliente.
        - ACTIVE: Cliente activo
        - INACTIVE: Cliente inactivo (puede reactivarse)
        - SUSPENDED: Cliente suspendido temporalmente
        - BLOCKED: Cliente bloqueado (requiere intervencion manual)

    PreferredLanguage:
      type: string
      enum:
        - es
        - en
        - pt
      description: Preferred communication language

    DocumentType:
      type: string
      enum:
        - RFC
        - CURP
        - INE
        - PASSPORT
      description: Tipo de documento de identidad

    Customer:
      type: object
      required:
        - customerId
        - firstName
        - lastName
        - email
        - documentType
        - documentNumber
        - status
        - createdAt
        - updatedAt
      properties:
        customerId:
          type: string
          format: uuid
          description: Identificador unico del cliente
          example: "c1d2e3f4-a5b6-7890-cdef-123456789abc"
        firstName:
          type: string
          description: Nombre del cliente
          example: "Maria"
        lastName:
          type: string
          description: Apellidos del cliente
          example: "Garcia Lopez"
        email:
          type: string
          format: email
          description: Correo electronico (unico)
          example: "maria.garcia@example.com"
        phone:
          type:
            - string
            - "null"
          description: Numero de telefono
          example: "+52-55-1234-5678"
        documentType:
          $ref: "#/components/schemas/DocumentType"
        documentNumber:
          type: string
          description: Numero de documento (unico por tipo)
          example: "GALM850101ABC"
        status:
          $ref: "#/components/schemas/CustomerStatus"
        address:
          $ref: "#/components/schemas/Address"
        preferredLanguage:
          $ref: "#/components/schemas/PreferredLanguage"
        createdAt:
          type: string
          format: date-time
          description: Fecha de creacion del registro
          example: "2024-01-05T12:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Fecha de ultima actualizacion
          example: "2024-01-05T12:00:00Z"

    Address:
      type: object
      properties:
        street:
          type: string
          description: Calle y numero
          example: "Av. Reforma 222, Piso 10"
        city:
          type: string
          description: Ciudad
          example: "Ciudad de Mexico"
        state:
          type: string
          description: Estado o provincia
          example: "CDMX"
        zipCode:
          type: string
          description: Codigo postal
          example: "06600"
        country:
          type: string
          description: Codigo de pais ISO 3166-1 alpha-2
          default: "MX"
          example: "MX"

    CreateCustomerRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - documentType
        - documentNumber
      properties:
        firstName:
          type: string
          description: Nombre del cliente
        lastName:
          type: string
          description: Apellidos del cliente
        email:
          type: string
          format: email
          description: Correo electronico (debe ser unico)
        phone:
          type: string
          description: Numero de telefono
        documentType:
          $ref: "#/components/schemas/DocumentType"
        documentNumber:
          type: string
          description: Numero de documento (debe ser unico por tipo)
        address:
          $ref: "#/components/schemas/Address"
        preferredLanguage:
          $ref: "#/components/schemas/PreferredLanguage"

    UpdateCustomerRequest:
      type: object
      properties:
        firstName:
          type: string
          description: Nombre del cliente
        lastName:
          type: string
          description: Apellidos del cliente
        phone:
          type: string
          description: Numero de telefono
        status:
          $ref: "#/components/schemas/CustomerStatus"
        address:
          $ref: "#/components/schemas/Address"
        preferredLanguage:
          $ref: "#/components/schemas/PreferredLanguage"

    PaginatedCustomerList:
      type: object
      required:
        - content
        - page
        - size
        - totalElements
        - totalPages
      properties:
        content:
          type: array
          items:
            $ref: "#/components/schemas/Customer"
        page:
          type: integer
          example: 0
        size:
          type: integer
          example: 20
        totalElements:
          type: integer
          format: int64
          example: 150
        totalPages:
          type: integer
          example: 8

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
        - path
      properties:
        error:
          type: string
          example: "VALIDATION_ERROR"
        message:
          type: string
          example: "email is required"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-05T12:00:00Z"
        path:
          type: string
          example: "/api/v1/customers"
        details:
          type: array
          items:
            type: string
