package com.guidewire.rules.commission;

import com.guidewire.rules.model.CommissionFact;
import java.math.BigDecimal;

// =============================================================================
// COMMISSION CALCULATION RULES
// Calculates agent commissions based on product type, premium amount,
// sales channel, agent tier, and experience
//
// Strategy:
// - Base rules use modify() to make commissionPercentage > 0.0 and
//   commissionTier == "BASE" visible to the Rete network, activating all
//   downstream rules in a single re-evaluation pass.
// - All downstream rules (tier bonus, channel, agent, experience, calculate)
//   use direct setters only -- they were activated by the base rule's modify
//   and fire in salience order without further re-evaluation.
// - Premium tier rules guard on commissionTier == "BASE" to fire only once.
//   Their premium ranges are mutually exclusive so only one can match.
// =============================================================================

// --- Base commission rates by product type (highest priority) ---

rule "AutoCommission"
    salience 100

    when
        $commission : CommissionFact(productType == "AUTO", commissionPercentage == 0.0)
    then
        modify($commission) {
            setCommissionPercentage(5.0),
            setCommissionTier("BASE")
        }
        $commission.addAppliedRule("Base AUTO rate: 5.0%");

end

rule "HomeCommission"
    salience 100

    when
        $commission : CommissionFact(productType == "HOME", commissionPercentage == 0.0)
    then
        modify($commission) {
            setCommissionPercentage(7.0),
            setCommissionTier("BASE")
        }
        $commission.addAppliedRule("Base HOME rate: 7.0%");

end

rule "LifeCommission"
    salience 100

    when
        $commission : CommissionFact(productType == "LIFE", commissionPercentage == 0.0)
    then
        modify($commission) {
            setCommissionPercentage(10.0),
            setCommissionTier("BASE")
        }
        $commission.addAppliedRule("Base LIFE rate: 10.0%");

end

rule "HealthCommission"
    salience 100

    when
        $commission : CommissionFact(productType == "HEALTH", commissionPercentage == 0.0)
    then
        modify($commission) {
            setCommissionPercentage(8.0),
            setCommissionTier("BASE")
        }
        $commission.addAppliedRule("Base HEALTH rate: 8.0%");

end

rule "CommercialCommission"
    salience 100

    when
        $commission : CommissionFact(productType == "COMMERCIAL", commissionPercentage == 0.0)
    then
        modify($commission) {
            setCommissionPercentage(6.0),
            setCommissionTier("BASE")
        }
        $commission.addAppliedRule("Base COMMERCIAL rate: 6.0%");

end

// --- Premium-based bonus tiers ---
// All guard on commissionTier == "BASE" to prevent re-triggering.
// Premium amount ranges are mutually exclusive so only one can match.
// Direct setters only (no modify) -- no downstream rule depends on tier value.

rule "PlatinumPremiumBonus"
    salience 70

    when
        $commission : CommissionFact(premiumAmount > 500000, commissionPercentage > 0.0,
                                     commissionTier == "BASE")
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 3.0);
        $commission.setCommissionTier("PLATINUM");
        $commission.addAppliedRule("Platinum premium bonus (+3.0%): premium > 500,000 MXN");

end

rule "GoldPremiumBonus"
    salience 65

    when
        $commission : CommissionFact(premiumAmount > 200000, premiumAmount <= 500000,
                                     commissionPercentage > 0.0,
                                     commissionTier == "BASE")
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 2.0);
        $commission.setCommissionTier("GOLD");
        $commission.addAppliedRule("Gold premium bonus (+2.0%): premium > 200,000 MXN");

end

rule "SilverPremiumBonus"
    salience 60

    when
        $commission : CommissionFact(premiumAmount > 50000, premiumAmount <= 200000,
                                     commissionPercentage > 0.0,
                                     commissionTier == "BASE")
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 1.0);
        $commission.setCommissionTier("SILVER");
        $commission.addAppliedRule("Silver premium bonus (+1.0%): premium > 50,000 MXN");

end

// --- Sales channel adjustments ---

rule "DirectChannelDiscount"
    salience 50

    when
        $commission : CommissionFact(salesChannel == "DIRECT", commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() - 1.0);
        $commission.addAppliedRule("Direct channel discount (-1.0%): no intermediary");

end

rule "BrokerChannelBonus"
    salience 50

    when
        $commission : CommissionFact(salesChannel == "BROKER", commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 2.0);
        $commission.addAppliedRule("Broker channel bonus (+2.0%): intermediary incentive");

end

rule "DigitalChannelDiscount"
    salience 50

    when
        $commission : CommissionFact(salesChannel == "DIGITAL", commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() - 2.0);
        $commission.addAppliedRule("Digital channel discount (-2.0%): self-service");

end

// --- Agent tier adjustments ---

rule "ExecutiveAgentBonus"
    salience 40

    when
        $commission : CommissionFact(agentTier == "EXECUTIVE", commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 2.0);
        $commission.addAppliedRule("Executive agent tier bonus (+2.0%)");

end

rule "SeniorAgentBonus"
    salience 40

    when
        $commission : CommissionFact(agentTier == "SENIOR", commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 1.0);
        $commission.addAppliedRule("Senior agent tier bonus (+1.0%)");

end

// --- Experience bonus ---

rule "ExperienceBonus_Veteran"
    salience 30

    when
        $commission : CommissionFact(yearsOfExperience > 10, commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 1.5);
        $commission.addAppliedRule("Veteran experience bonus (+1.5%): 10+ years");

end

rule "ExperienceBonus_Experienced"
    salience 30

    when
        $commission : CommissionFact(yearsOfExperience > 5, yearsOfExperience <= 10,
                                     commissionPercentage > 0.0)
    then
        $commission.setCommissionPercentage($commission.getCommissionPercentage() + 0.5);
        $commission.addAppliedRule("Experience bonus (+0.5%): 5-10 years");

end

// --- Final commission amount calculation ---

rule "CalculateCommissionAmount"
    salience 1

    when
        $commission : CommissionFact(commissionPercentage > 0.0, premiumAmount != null,
                                     commissionAmount == null)
    then
        $commission.calculateCommissionAmount();
        $commission.addAppliedRule("Final commission: " + $commission.getCommissionPercentage() +
                                  "% of " + $commission.getPremiumAmount() +
                                  " = " + $commission.getCommissionAmount() + " MXN");

end
