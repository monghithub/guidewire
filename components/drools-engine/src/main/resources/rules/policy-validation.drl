package com.guidewire.rules.policy;

import com.guidewire.rules.model.PolicyFact;
import java.math.BigDecimal;

// =============================================================================
// POLICY VALIDATION RULES
// Validates policy creation requests: required fields, coverage limits,
// age restrictions, and customer status
//
// Strategy:
// - RequiredField rules that set eligible=false use modify() so that
//   lower-salience rules checking eligible == true see the updated value.
//   Property-reactivity ensures the RequiredField rules themselves don't
//   re-trigger (they check policyId, customerId, etc. -- not eligible).
// - RequiredField_CustomerName does NOT set eligible, so no modify needed.
// - CustomerNotActive and all age/limit/premium rules that set eligible=false
//   also use modify() so SetRejectionFromValidationErrors (which checks
//   eligible == false) activates correctly.
// - addValidationError() just accumulates list entries -- no modify needed.
// =============================================================================

// --- Required field validations (highest priority) ---

rule "RequiredField_PolicyId"
    salience 300

    when
        $policy : PolicyFact(policyId == null || policyId == "")
    then
        modify($policy) { setEligible(false) }
        $policy.addValidationError("Policy ID is required");

end

rule "RequiredField_CustomerId"
    salience 300

    when
        $policy : PolicyFact(customerId == null || customerId == "")
    then
        modify($policy) { setEligible(false) }
        $policy.addValidationError("Customer ID is required");

end

rule "RequiredField_ProductType"
    salience 300

    when
        $policy : PolicyFact(productType == null || productType == "")
    then
        modify($policy) { setEligible(false) }
        $policy.addValidationError("Product type is required");

end

rule "RequiredField_PremiumAmount"
    salience 300

    when
        $policy : PolicyFact(premiumAmount == null)
    then
        modify($policy) { setEligible(false) }
        $policy.addValidationError("Premium amount is required");

end

rule "RequiredField_CustomerName"
    salience 300

    when
        $policy : PolicyFact(customerName == null || customerName == "")
    then
        $policy.addValidationError("Customer name is required (warning)");

end

// --- Customer status validation ---

rule "CustomerNotActive"
    salience 200
    when
        $policy : PolicyFact(customerStatus != null, customerStatus != "ACTIVE", eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Customer status is not ACTIVE. Current status: " + $policy.getCustomerStatus());
        $policy.addValidationError("Customer must have ACTIVE status. Current: " + $policy.getCustomerStatus());

end

// --- Age restriction rules ---

rule "MinimumAge_Auto"
    salience 150
    when
        $policy : PolicyFact(productType == "AUTO", customerAge > 0, customerAge < 18, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Customer must be at least 18 years old for AUTO policies");
        $policy.addValidationError("Minimum age for AUTO policy is 18. Customer age: " + $policy.getCustomerAge());

end

rule "MinimumAge_Life"
    salience 150
    when
        $policy : PolicyFact(productType == "LIFE", customerAge > 0, customerAge < 18, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Customer must be at least 18 years old for LIFE policies");
        $policy.addValidationError("Minimum age for LIFE policy is 18. Customer age: " + $policy.getCustomerAge());

end

rule "MaximumAge_Life"
    salience 150
    when
        $policy : PolicyFact(productType == "LIFE", customerAge > 75, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Customer exceeds maximum age of 75 for LIFE policies");
        $policy.addValidationError("Maximum age for LIFE policy is 75. Customer age: " + $policy.getCustomerAge());

end

rule "MaximumAge_Health"
    salience 150
    when
        $policy : PolicyFact(productType == "HEALTH", customerAge > 80, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Customer exceeds maximum age of 80 for HEALTH policies");
        $policy.addValidationError("Maximum age for HEALTH policy is 80. Customer age: " + $policy.getCustomerAge());

end

// --- Coverage limit rules ---

rule "MaxAutoLimit"
    salience 100
    when
        $policy : PolicyFact(productType == "AUTO", premiumAmount > 100000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount exceeds maximum limit of 100,000 MXN for AUTO policies");
        $policy.addValidationError("AUTO premium limit is 100,000 MXN. Requested: " + $policy.getPremiumAmount());

end

rule "MaxHomeLimit"
    salience 100
    when
        $policy : PolicyFact(productType == "HOME", premiumAmount > 500000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount exceeds maximum limit of 500,000 MXN for HOME policies");
        $policy.addValidationError("HOME premium limit is 500,000 MXN. Requested: " + $policy.getPremiumAmount());

end

rule "MaxLifeLimit"
    salience 100
    when
        $policy : PolicyFact(productType == "LIFE", premiumAmount > 1000000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount exceeds maximum limit of 1,000,000 MXN for LIFE policies");
        $policy.addValidationError("LIFE premium limit is 1,000,000 MXN. Requested: " + $policy.getPremiumAmount());

end

rule "MaxHealthLimit"
    salience 100
    when
        $policy : PolicyFact(productType == "HEALTH", premiumAmount > 300000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount exceeds maximum limit of 300,000 MXN for HEALTH policies");
        $policy.addValidationError("HEALTH premium limit is 300,000 MXN. Requested: " + $policy.getPremiumAmount());

end

rule "MaxCommercialLimit"
    salience 100
    when
        $policy : PolicyFact(productType == "COMMERCIAL", premiumAmount > 5000000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount exceeds maximum limit of 5,000,000 MXN for COMMERCIAL policies");
        $policy.addValidationError("COMMERCIAL premium limit is 5,000,000 MXN. Requested: " + $policy.getPremiumAmount());

end

// --- Minimum premium rules ---

rule "MinimumPremium"
    salience 100
    when
        $policy : PolicyFact(premiumAmount != null, premiumAmount < 1000, eligible == true)
    then
        modify($policy) { setEligible(false) }
        $policy.setRejectionReason("Premium amount is below minimum of 1,000 MXN");
        $policy.addValidationError("Minimum premium is 1,000 MXN. Requested: " + $policy.getPremiumAmount());

end

// --- Set rejection reason from validation errors if not already set ---

rule "SetRejectionFromValidationErrors"
    salience 1

    when
        $policy : PolicyFact(eligible == false, rejectionReason == null,
                             validationErrors != null, validationErrors.size() > 0)
    then
        $policy.setRejectionReason($policy.getValidationErrors().get(0));

end
