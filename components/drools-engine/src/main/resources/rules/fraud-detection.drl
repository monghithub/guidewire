package com.guidewire.rules.fraud;

import com.guidewire.rules.model.ClaimFact;
import java.math.BigDecimal;

// =============================================================================
// FRAUD DETECTION RULES
// Evaluates claims for suspicious patterns and assigns risk levels + fraud score
// Score range: 0 (clean) to 100 (highly suspicious)
//
// Strategy: Score accumulation rules use direct setters only (no update/modify).
// They are all activated at insert time based on input fields (claimedAmount,
// daysSinceRegistration, claimCount, etc.) and fire in salience order.
// A single AssignRiskLevel rule fires last (salience 1) and reads the final
// fraudScore directly from the Java object in its THEN block.
// =============================================================================

// --- Amount-based rules ---

rule "SuspiciousAmount_Critical"
    salience 100

    when
        $claim : ClaimFact(claimedAmount > 1000000)
    then
        $claim.setFraudScore($claim.getFraudScore() + 70);
        $claim.addFlaggedReason("Claimed amount exceeds 1,000,000 MXN - CRITICAL threshold");

end

rule "HighAmountClaim"
    salience 95

    when
        $claim : ClaimFact(claimedAmount > 500000, claimedAmount <= 1000000)
    then
        $claim.setFraudScore($claim.getFraudScore() + 25);
        $claim.addFlaggedReason("Claimed amount exceeds 500,000 MXN - HIGH risk threshold");

end

rule "MediumAmountClaim"
    salience 90

    when
        $claim : ClaimFact(claimedAmount > 200000, claimedAmount <= 500000)
    then
        $claim.setFraudScore($claim.getFraudScore() + 10);
        $claim.addFlaggedReason("Claimed amount exceeds 200,000 MXN - elevated amount");

end

// --- Temporal pattern rules ---

rule "NewCustomerImmediateClaim"
    salience 80

    when
        $claim : ClaimFact(daysSinceRegistration() <= 30)
    then
        $claim.setFraudScore($claim.getFraudScore() + 30);
        $claim.addFlaggedReason("Claim filed within 30 days of customer registration - suspicious timing");

end

rule "RecentCustomerClaim"
    salience 75

    when
        $claim : ClaimFact(daysSinceRegistration() > 30, daysSinceRegistration() <= 90)
    then
        $claim.setFraudScore($claim.getFraudScore() + 15);
        $claim.addFlaggedReason("Claim filed within 90 days of customer registration - watch pattern");

end

// --- Frequency-based rules ---

rule "FrequentClaimant_Extreme"
    salience 70

    when
        $claim : ClaimFact(claimCount > 5)
    then
        $claim.setFraudScore($claim.getFraudScore() + 35);
        $claim.addFlaggedReason("Customer has more than 5 claims in the last 12 months - repeat pattern");

end

rule "FrequentClaimant_High"
    salience 65

    when
        $claim : ClaimFact(claimCount > 3, claimCount <= 5)
    then
        $claim.setFraudScore($claim.getFraudScore() + 20);
        $claim.addFlaggedReason("Customer has more than 3 claims in the last 12 months");

end

// --- Pattern matching rules ---

rule "TheftWithoutPoliceReport"
    salience 60

    when
        $claim : ClaimFact(claimType == "THEFT", hasPoliceReport == false)
    then
        $claim.setFraudScore($claim.getFraudScore() + 25);
        $claim.addFlaggedReason("Theft claim filed without a police report");

end

rule "HighAmountNoWitnesses"
    salience 55

    when
        $claim : ClaimFact(claimedAmount > 300000, hasWitnesses == false, claimType != "FLOOD")
    then
        $claim.setFraudScore($claim.getFraudScore() + 15);
        $claim.addFlaggedReason("High-value claim with no witnesses");

end

rule "NewCustomerHighAmountTheft"
    salience 50

    when
        $claim : ClaimFact(daysSinceRegistration() <= 60, claimedAmount > 500000, claimType == "THEFT")
    then
        $claim.setFraudScore($claim.getFraudScore() + 20);
        $claim.addFlaggedReason("COMPOUND: New customer + high amount + theft = elevated risk pattern");

end

// --- Risk level assignment based on cumulative fraud score ---
// Single rule that reads the final score from the Java object after all
// accumulation rules have fired. Uses Java if/else in the THEN block to
// avoid depending on Rete-cached fraudScore values in the WHEN clause.

rule "AssignRiskLevel"
    salience 1

    when
        $claim : ClaimFact(riskLevel == null)
    then
        int score = $claim.getFraudScore();
        if (score >= 70) {
            $claim.setRiskLevel("CRITICAL");
        } else if (score >= 40) {
            $claim.setRiskLevel("HIGH");
        } else if (score >= 20) {
            $claim.setRiskLevel("MEDIUM");
        } else {
            $claim.setRiskLevel("LOW");
        }

end
