name: CI - Build, Test & Validate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: "21"
  NODE_VERSION: "20"

jobs:
  # ---------------------------------------------------------------------------
  # Java services: camel-gateway, drools-engine, billing-service
  # Built with Maven (standard mvn)
  # ---------------------------------------------------------------------------
  build-java-services:
    name: "Build Java - ${{ matrix.service }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - camel-gateway
          - drools-engine
          - billing-service
    defaults:
      run:
        working-directory: components/${{ matrix.service }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build with Maven
        run: mvn clean verify -B -DskipTests

      - name: Run unit tests
        run: mvn test -B

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.service }}
          path: components/${{ matrix.service }}/target/surefire-reports/
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Quarkus service: incidents-service
  # Uses Maven Wrapper (./mvnw)
  # ---------------------------------------------------------------------------
  build-incidents-service:
    name: "Build Quarkus - incidents-service"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: components/incidents-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Make mvnw executable
        run: chmod +x ./mvnw || true

      - name: Build with Maven Wrapper
        run: |
          if [ -f ./mvnw ]; then
            ./mvnw clean verify -B -DskipTests
          else
            mvn clean verify -B -DskipTests
          fi

      - name: Run unit tests
        run: |
          if [ -f ./mvnw ]; then
            ./mvnw test -B
          else
            mvn test -B
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-incidents-service
          path: components/incidents-service/target/surefire-reports/
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Node.js service: customers-service
  # ---------------------------------------------------------------------------
  build-customers-service:
    name: "Build Node.js - customers-service"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: components/customers-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: components/customers-service/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run linter
        run: npm run lint --if-present

      - name: Run build
        run: npm run build

      - name: Run tests
        run: npm test

  # ---------------------------------------------------------------------------
  # Contract validation: OpenAPI (Spectral) + AsyncAPI + AVRO
  # ---------------------------------------------------------------------------
  contract-validation:
    name: "Validate API Contracts"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli

      - name: Lint OpenAPI specs with Spectral
        run: |
          echo "=== Linting OpenAPI specifications ==="
          for spec in contracts/openapi/*.yml; do
            echo "--- Linting: $spec ---"
            spectral lint "$spec" --fail-severity error
          done

      - name: Install AsyncAPI CLI
        run: npm install -g @asyncapi/cli || true

      - name: Validate AsyncAPI spec
        run: |
          echo "=== Validating AsyncAPI specification ==="
          if command -v asyncapi &> /dev/null; then
            asyncapi validate contracts/asyncapi/guidewire-events.yml
          else
            echo "AsyncAPI CLI not available, skipping validation"
          fi

      - name: Validate AVRO schemas (JSON syntax)
        run: |
          echo "=== Validating AVRO schemas (JSON syntax check) ==="
          for schema in contracts/avro/*.avsc; do
            echo "--- Validating: $schema ---"
            python3 -c "import json; json.load(open('$schema'))" && echo "  OK: valid JSON" || echo "  FAIL: invalid JSON"
          done

      - name: Verify OpenAPI spec references exist
        run: |
          echo "=== Verifying OpenAPI specs referenced by services ==="
          specs=(
            "contracts/openapi/billing-service-api.yml"
            "contracts/openapi/incidents-service-api.yml"
            "contracts/openapi/customers-service-api.yml"
            "contracts/openapi/policycenter-api.yml"
            "contracts/openapi/claimcenter-api.yml"
            "contracts/openapi/billingcenter-api.yml"
            "contracts/openapi/drools-engine-api.yml"
            "contracts/openapi/camel-gateway-api.yml"
          )
          for spec in "${specs[@]}"; do
            if [ -f "$spec" ]; then
              echo "  OK: $spec"
            else
              echo "  FAIL: $spec not found"
              exit 1
            fi
          done

  # ---------------------------------------------------------------------------
  # Security scans
  # ---------------------------------------------------------------------------
  security-scan:
    name: "Security Scan"
    runs-on: ubuntu-latest
    needs:
      - build-java-services
      - build-incidents-service
      - build-customers-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: npm audit (Node.js dependencies)
        continue-on-error: true
        run: cd components/customers-service && npm audit --audit-level=high

      - name: Trivy vulnerability scan (filesystem)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'table'

      - name: Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # E2E tests with Newman
  # ---------------------------------------------------------------------------
  e2e-tests:
    name: "E2E Tests (Newman)"
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    needs:
      - build-java-services
      - build-incidents-service
      - build-customers-service
      - contract-validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run E2E tests
        continue-on-error: true
        run: |
          newman run contracts/postman/guidewire-e2e.postman_collection.json \
            -e contracts/postman/local.postman_environment.json \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export results/e2e-report.html \
            --delay-request 500 \
            --timeout-request 10000

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-test-results
          path: results/
          retention-days: 14
